name: Validate urls.json

on:
  pull_request:
    paths:
      - 'urls.json'
      - '.github/workflows/validate-urls.yml'
      - '.github/scripts/check_urls.py'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed so we can compare against origin/<base>

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run URL validation
        id: validate
        continue-on-error: true
        run: |
          python .github/scripts/check_urls.py > validate_output.txt 2>&1
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"

      - name: Comment on PR if validation failed
        if: steps.validate.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const core = require('@actions/core');

            const output = fs.readFileSync('validate_output.txt', 'utf8');
            const trimmed = output.length > 6000
              ? output.slice(0, 6000) + '\nâ€¦ (truncated)'
              : output;

            const body = [
              'ðŸš« **Zilchy.link URL validation failed**',
              '',
              '```text',
              trimmed,
              '```',
              '',
              'Please fix the issues above and push a new commit. '
              + 'This check enforces: safe URLs, allowed content, canonical formatting, '
              + 'and no modification/removal of existing codes.',
            ].join('\n');

            const prNumber = context.payload.pull_request?.number;
            if (!prNumber) {
              core.warning('No pull request number found; not adding a comment.');
            } else {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: prNumber,
                body
              });
            }

            core.setFailed('urls.json validation failed.');
